<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Order Dashboard | OPEN MARKET</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .orders-wrapper {
      max-width: 1000px;
      margin: 80px auto 30px;
      padding: 20px;
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    }

    .orders-wrapper h2 {
      text-align: center;
      margin-bottom: 20px;
      color: var(--primary);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 0.95rem;
    }

    th, td {
      padding: 10px;
      border: 1px solid var(--border-color);
      text-align: left;
    }

    th {
      background: var(--primary);
      color: white;
    }

    tr:nth-child(even) {
      background: #f9f9f9;
    }

    .expand-btn {
      cursor: pointer;
      color: var(--primary);
      font-weight: bold;
    }

    .cart-content {
      font-size: 0.9em;
      background: #eef8f0;
      padding: 10px;
      border-radius: 6px;
      margin-top: 6px;
    }

    .dark-mode .cart-content {
      background: #223322;
    }

    #darkToggle {
      position: fixed;
      bottom: 20px;
      right: 80px;
      background: var(--primary);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.9rem;
      z-index: 999;
    }

    #darkToggle:hover {
      background: var(--primary-hover);
    }
  </style>
</head>
<body>
  <a href="cart.html" class="mini-cart">üõí<span id="cartCount">0</span></a>
  <button id="darkToggle">üåô Dark Mode</button>

  <div class="orders-wrapper">
    <h2>üì¶ Customer Orders</h2>
    <div id="ordersTable">Loading orders...</div>
  </div>

  <script>
    const sheetURL = "https://script.google.com/macros/s/AKfycbx66cE0kb-1Q_MWxSF31cDXF9vPbHmb0J7HrJ-JL1abSKfMfdwliYP9MrDLfi6q5_k-5Q/exec";

    fetch(sheetURL)
      .then(res => res.json())
      .then(data => {
        const div = document.getElementById("ordersTable");
        if (!Array.isArray(data) || !data.length) {
          div.innerHTML = "<p>No orders found.</p>";
          return;
        }

        let html = `<table><tr>
          <th>Name</th>
          <th>Phone</th>
          <th>Delivery</th>
          <th>Total</th>
          <th>Time</th>
          <th>Cart</th>
        </tr>`;

        data.forEach((order, i) => {
          const cartID = `cart-${i}`;
          html += `
            <tr>
              <td>${order.name}</td>
              <td>${order.phone}</td>
              <td>${order.delivery}</td>
              <td>‚Çµ${order.total}</td>
              <td>${order.timestamp}</td>
              <td><span class="expand-btn" onclick="toggleCart('${cartID}')">üß∫ View</span></td>
            </tr>
            <tr id="${cartID}" style="display:none;">
              <td colspan="6">
                <div class="cart-content">${formatCart(order.cart)}</div>
              </td>
            </tr>
          `;
        });

        html += "</table>";
        div.innerHTML = html;
      })
      .catch((err) => {
        console.error("Fetch error:", err);
        document.getElementById("ordersTable").innerHTML =
          "<p>Something went wrong while loading orders.</p>";
      });

    function toggleCart(id) {
      const row = document.getElementById(id);
      row.style.display = row.style.display === "none" ? "table-row" : "none";
    }

    function formatCart(cart) {
      try {
        const items = JSON.parse(cart);
        if (!Array.isArray(items)) return "<i>Invalid cart format.</i>";
        return items.map(p => `<strong>${p.title}</strong> ‚Äì ‚Çµ${p.price}<br/>`).join("");
      } catch {
        return "<i>Error parsing cart</i>";
      }
    }

    const cart = JSON.parse(localStorage.getItem("cart") || "[]");
    const cartCount = document.getElementById("cartCount");
    if (cartCount) cartCount.textContent = cart.length;

    const toggle = document.getElementById("darkToggle");
    toggle.addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
      toggle.textContent = document.body.classList.contains("dark-mode")
        ? "‚òÄÔ∏è Light Mode"
        : "üåô Dark Mode";
    });
  </script>
</body>
</html>
